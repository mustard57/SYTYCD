<message message-id="20070513190438.BF78B1A9838@eris.apache.org" list="org.apache.jackrabbit.commits" id="24cvacfmmc5zkdpd" type="checkins" date="2007-05-13T19:04:38Z" year="2007-01-01" year-month="2007-05-01" year-month-day="2007-05-13" thread-id="24cvacfmmc5zkdpd"><headers><envelope-from-line>From commits-return-4002-apmail-jackrabbit-commits-archive=jackrabbit.apache.org@jackrabbit.apache.org Sun May 13 19:05:01 2007</envelope-from-line><from personal="clombart@apache.org" address="clombart@apache.org">clombart@apache.org</from><to personal="commits@jackrabbit.apache.org" address="commits@jackrabbit.apache.org">commits@jackrabbit.apache.org</to><subject normal="svn commit: r537641 - in /jackrabbit/trunk/contrib/jackrabbit-jcr-mapping/jcr-mapping/src: main/java/org/apache/jackrabbit/ocm/persistence/impl/ test/java/org/apache/jackrabbit/ocm/persistence/lock/">svn commit: r537641 - in
 /jackrabbit/trunk/contrib/jackrabbit-jcr-mapping/jcr-mapping/src:
 main/java/org/apache/jackrabbit/ocm/persistence/impl/
 test/java/org/apache/jackrabbit/ocm/persistence/lock/</subject><return-path>commits-return-4002-apmail-jackrabbit-commits-archive=jackrabbit.apache.org@jackrabbit.apache.org</return-path><delivered-to>apmail-jackrabbit-commits-archive@www.apache.org</delivered-to><received>(qmail 91506 invoked from network); 13 May 2007 19:04:59 -0000</received><received>from hermes.apache.org (HELO mail.apache.org) (140.211.11.2)
  by minotaur.apache.org with SMTP; 13 May 2007 19:04:59 -0000</received><received>(qmail 62255 invoked by uid 500); 13 May 2007 19:05:06 -0000</received><delivered-to>apmail-jackrabbit-commits-archive@jackrabbit.apache.org</delivered-to><received>(qmail 62225 invoked by uid 500); 13 May 2007 19:05:06 -0000</received><mailing-list>contact commits-help@jackrabbit.apache.org; run by ezmlm</mailing-list><precedence>bulk</precedence><list-help>&lt;mailto:commits-help@jackrabbit.apache.org&gt;</list-help><list-unsubscribe>&lt;mailto:commits-unsubscribe@jackrabbit.apache.org&gt;</list-unsubscribe><list-post>&lt;mailto:commits@jackrabbit.apache.org&gt;</list-post><list-id>&lt;commits.jackrabbit.apache.org&gt;</list-id><reply-to>dev@jackrabbit.apache.org</reply-to><delivered-to>mailing list commits@jackrabbit.apache.org</delivered-to><received>(qmail 62216 invoked by uid 99); 13 May 2007 19:05:06 -0000</received><received>from herse.apache.org (HELO herse.apache.org) (140.211.11.133)
    by apache.org (qpsmtpd/0.29) with ESMTP; Sun, 13 May 2007 12:05:06 -0700</received><x-asf-spam-status>No, hits=-99.5 required=10.0
	tests=ALL_TRUSTED,NO_REAL_NAME</x-asf-spam-status><x-spam-check-by>apache.org</x-spam-check-by><received>from [140.211.11.3] (HELO eris.apache.org) (140.211.11.3)
    by apache.org (qpsmtpd/0.29) with ESMTP; Sun, 13 May 2007 12:04:58 -0700</received><received>by eris.apache.org (Postfix, from userid 65534)
	id BF78B1A9838; Sun, 13 May 2007 12:04:38 -0700 (PDT)</received><content-type>text/plain; charset="utf-8"</content-type><mime-version>1.0</mime-version><content-transfer-encoding>7bit</content-transfer-encoding><date>Sun, 13 May 2007 19:04:38 -0000</date><x-mailer>svnmailer-1.1.0</x-mailer><message-id>20070513190438.BF78B1A9838@eris.apache.org</message-id><x-virus-checked>Checked by ClamAV on apache.org</x-virus-checked></headers><normalized-references><normalized-message-id>20070513190438.BF78B1A9838@eris.apache.org</normalized-message-id></normalized-references><body type="text/plain; charset=&quot;utf-8&quot;"><para depth="0">Author: clombart
Date: Sun May 13 12:04:37 2007
New Revision: 537641

</para><para depth="0">URL: <url>http://svn.apache.org/viewvc?view=rev&amp;rev=537641</url>
Log:
Bug fix for JCR-909. Now, we check if the lock owner is the current session <br/>user. 
Modify unit test for locks

</para><para depth="0">Modified:
<br/>jackrabbit/trunk/contrib/jackrabbit-jcr-mapping/jcr-mapping/src/main/java/org/apache/jackrabbit/ocm/persistence/impl/PersistenceManagerImpl.java 
<br/>jackrabbit/trunk/contrib/jackrabbit-jcr-mapping/jcr-mapping/src/test/java/org/apache/jackrabbit/ocm/persistence/lock/PersistenceManagerLockTest.java 

</para><para depth="0">Modified: <br/>jackrabbit/trunk/contrib/jackrabbit-jcr-mapping/jcr-mapping/src/main/java/org/apache/jackrabbit/ocm/persistence/impl/PersistenceManagerImpl.java 
URL: <br/><url>http://svn.apache.org/viewvc/jackrabbit/trunk/contrib/jackrabbit-jcr-mapping/jcr-mapping/src/main/java/org/apache/jackrabbit/ocm/persistence/impl/PersistenceManagerImpl.java?view=diff&amp;rev=537641&amp;r1=537640&amp;r2=537641</url> 
==============================================================================
--- <br/>jackrabbit/trunk/contrib/jackrabbit-jcr-mapping/jcr-mapping/src/main/java/org/apache/jackrabbit/ocm/persistence/impl/PersistenceManagerImpl.java <br/>(original) 
+++ <br/>jackrabbit/trunk/contrib/jackrabbit-jcr-mapping/jcr-mapping/src/main/java/org/apache/jackrabbit/ocm/persistence/impl/PersistenceManagerImpl.java <br/>Sun May 13 12:04:37 2007 
@@ -1000,8 +1000,12 @@
         if (node.isLocked()) {
             Lock lock = node.getLock();
             String lockOwner = lock.getLockOwner();
-            final String path = lock.getNode().getPath();
-            throw new LockedException(lockOwner, path);
+            
+            if (! session.getUserID().equals(lockOwner))
+            {
+                final String path = lock.getNode().getPath();
+                throw new LockedException(lockOwner, path);
+            }
         }
     }

</para><para depth="0">Modified: <br/>jackrabbit/trunk/contrib/jackrabbit-jcr-mapping/jcr-mapping/src/test/java/org/apache/jackrabbit/ocm/persistence/lock/PersistenceManagerLockTest.java 
URL: <br/><url>http://svn.apache.org/viewvc/jackrabbit/trunk/contrib/jackrabbit-jcr-mapping/jcr-mapping/src/test/java/org/apache/jackrabbit/ocm/persistence/lock/PersistenceManagerLockTest.java?view=diff&amp;rev=537641&amp;r1=537640&amp;r2=537641</url> 
==============================================================================
--- <br/>jackrabbit/trunk/contrib/jackrabbit-jcr-mapping/jcr-mapping/src/test/java/org/apache/jackrabbit/ocm/persistence/lock/PersistenceManagerLockTest.java <br/>(original) 
+++ <br/>jackrabbit/trunk/contrib/jackrabbit-jcr-mapping/jcr-mapping/src/test/java/org/apache/jackrabbit/ocm/persistence/lock/PersistenceManagerLockTest.java <br/>Sun May 13 12:04:37 2007 
@@ -139,6 +139,17 @@
             // Check if the object is locked
// <br/>-------------------------------------------------------------------------------- 
assertFalse("the object is locked", persistenceManager.isLocked("/test")); 
+
+ // <br/>-------------------------------------------------------------------------------- 
+            // Lock &amp; update 
+ // <br/>-------------------------------------------------------------------------------- 
+            lockToken = persistenceManager.lock("/test", true, false);
+            a = (A) persistenceManager.getObject("/test");
+            a.setA1("new a1 Value");
+            persistenceManager.update(a);
+            persistenceManager.save();
+            persistenceManager.unlock("/test", lockToken);
+            

</para><para depth="0">// <br/>-------------------------------------------------------------------------------- 
             // Remove the object

</para></body></message>