<message message-id="20040910160909.GA17286@openssl.org" list="org.openssl.openssl-users" id="24ckrpocz5kdylay" type="users" date="2004-09-10T18:09:09+02:00" year="2004-01-01" year-month="2004-09-01" year-month-day="2004-09-10" thread-id="7oain6gzx4hafj3z"><headers><envelope-from-line>From nntpsnarfer@fakefrom.com  Mon Jan  1 12:00:00 1990</envelope-from-line><from personal="Dr. Stephen Henson" address="steve-MCmKBN63+BlAfugRpC6u6w@public.gmane.org">"Dr. Stephen Henson" &lt;steve-MCmKBN63+BlAfugRpC6u6w@public.gmane.org&gt;</from><subject normal="Trouble using PKCS5_pbe2_set()">Re: Trouble using PKCS5_pbe2_set()</subject><path>main.gmane.org!not-for-mail</path><newsgroups>gmane.comp.encryption.openssl.user</newsgroups><date>Fri, 10 Sep 2004 18:09:09 +0200</date><organization>OpenSSL Project</organization><lines>41</lines><sender>owner-openssl-users-MCmKBN63+BlAfugRpC6u6w@public.gmane.org</sender><approved>news@gmane.org</approved><message-id>20040910160909.GA17286@openssl.org</message-id><references>&lt;4141C8F8.9070805@uk.radan.com&gt;</references><reply-to>openssl-users-MCmKBN63+BlAfugRpC6u6w@public.gmane.org</reply-to><nntp-posting-host>deer.gmane.org</nntp-posting-host><mime-version>1.0</mime-version><content-type>text/plain; charset=us-ascii</content-type><x-trace>sea.gmane.org 1094833395 12572 80.91.224.253 (10 Sep 2004 16:23:15 GMT)</x-trace><x-complaints-to>usenet@sea.gmane.org</x-complaints-to><nntp-posting-date>Fri, 10 Sep 2004 16:23:15 +0000 (UTC)</nntp-posting-date><original-x-from>owner-mmx-openssl-users-w8N0r6uhvJHfKM7srBC2yEEOCMrvLtNR@public.gmane.org Fri Sep 10 18:23:10 2004</original-x-from><return-path>owner-mmx-openssl-users-w8N0r6uhvJHfKM7srBC2yEEOCMrvLtNR@public.gmane.org</return-path><original-received>from mmx.engelschall.com ([195.27.130.252])
	by deer.gmane.org with esmtp (Exim 3.35 #1 (Debian))
	id 1C5nyf-0007Vi-00
	for &lt;openssl-users@m.gmane.org&gt;; Fri, 10 Sep 2004 18:10:21 +0200</original-received><original-received>by mmx.engelschall.com (Postfix)
	id 7DCFF19370; Fri, 10 Sep 2004 18:09:09 +0200 (CEST)</original-received><original-received>from master.openssl.org (master.openssl.org [195.27.176.155])
	by mmx.engelschall.com (Postfix) with ESMTP id 6981A19328
	for &lt;mmx-openssl-users-w8N0r6uhvJHfKM7srBC2yEEOCMrvLtNR@public.gmane.org&gt;; Fri, 10 Sep 2004 18:09:09 +0200 (CEST)</original-received><original-received>by master.openssl.org (Postfix)
	id BF1B02036EE; Fri, 10 Sep 2004 18:09:10 +0200 (CEST)</original-received><delivered-to>openssl-users-l-P6BqreUs7qIPwi1/lhCOyh2eb7JE58TQ@public.gmane.org</delivered-to><original-received>by master.openssl.org (Postfix, from userid 5003)
	id AEFFF203685; Fri, 10 Sep 2004 18:09:10 +0200 (CEST)</original-received><x-original-to>openssl-users-MCmKBN63+BlAfugRpC6u6w@public.gmane.org</x-original-to><delivered-to>openssl-users-MCmKBN63+BlAfugRpC6u6w@public.gmane.org</delivered-to><original-received>by master.openssl.org (Postfix, from userid 5012)
	id 15236203633; Fri, 10 Sep 2004 18:09:10 +0200 (CEST)</original-received><original-to>openssl-users-MCmKBN63+BlAfugRpC6u6w@public.gmane.org</original-to><content-disposition>inline</content-disposition><in-reply-to>&lt;4141C8F8.9070805-8Pownqb8XdpWk0Htik3J/w@public.gmane.org&gt;</in-reply-to><user-agent>Mutt/1.4.2.1i</user-agent><x-web-homepage>http://www.openssl.org/~steve/</x-web-homepage><precedence>bulk</precedence><x-sender>"Dr. Stephen Henson" &lt;steve-MCmKBN63+BlAfugRpC6u6w@public.gmane.org&gt;</x-sender><x-list-manager>OpenSSL Majordomo [version 1.94.5]</x-list-manager><x-list-name>openssl-users</x-list-name><xref>main.gmane.org gmane.comp.encryption.openssl.user:14337</xref><x-report-spam>http://spam.gmane.org/gmane.comp.encryption.openssl.user:14337</x-report-spam></headers><normalized-references><normalized-message-id>20040910160909.GA17286@openssl.org</normalized-message-id><normalized-in-reply-to>4141C8F8.9070805-8Pownqb8XdpWk0Htik3J/w@public.gmane.org</normalized-in-reply-to><normalized-reference>4141C8F8.9070805@uk.radan.com</normalized-reference></normalized-references><body type="text/plain; charset=us-ascii"><para depth="0">On Fri, Sep 10, 2004, Steve Hay wrote:

</para><quote depth="1"><quotepara depth="1">As an alternative to my luckless attempts at using 
EVP_CIPHER_param_to_asn1() + PKCS5_v2_PBE_keyivgen(), I thought I would 
try PKCS5_pbe2_set() + EVP_PBE_CipherInit(), but I've run into the 
problem that I thought I would have:  PKCS5_pbe2_set() randomly 
generates its own IV, so that trying to decrypt previously encrypted 
data doesn't work.  (Or at least, I think that's what the problem is.)

</quotepara><quotepara depth="1">I thought that calling

</quotepara><quotepara depth="1">    EVP_CipherInit_ex(&amp;ctx, cipher, NULL, NULL, iv, crypt_mode);

</quotepara><quotepara depth="1">after the EVP_PBE_CipherInit() call would replace the iv set by 
PKCS5_pbe2_set() with my own one, but it seems to make no difference, as 
the attached sample program demonstrates.

</quotepara><quotepara depth="1">Running "cryptfile.exe in.txt out.txt 1" followed by "cryptfile.exe 
out.txt newin.txt 0" fails during the second (decryption) call.  (My 
in.txt is a 1-byte file containing just "1".)

</quotepara><quotepara depth="1">Is there any way to "override" PKCS5_pbe2_set()'s iv with my own, or am 
I barking up the wrong tree here?

</quotepara></quote><para depth="0">Currently you can't set the IV yourself in PKCS5_pbe2_set(). If you however
just want to save and restore the random IV (along with the parameters used
for the key) you can use the {i2d,d2i}_ASN1_TYPE() functions to save and
restore this to and from a memory buffer along with the salt and key length.

</para><para depth="0">Steve.
</para><footer type="signature" depth="0" hash="3604311795139989781">--
Dr Stephen N. Henson. Email, S/MIME and PGP keys: see homepage
OpenSSL project core developer and freelance consultant.
Funding needed! Details on homepage.
Homepage: <url>http://www.drh-consultancy.demon.co.uk</url>
</footer><footer type="list-management" depth="0">______________________________________________________________________
OpenSSL Project                                 <url>http://www.openssl.org</url>
User Support Mailing List<br/>openssl-users-MCmKBN63+<email>BlAfugRpC6u6w@public.gmane.org</email>
Automated List Manager<br/>majordomo-MCmKBN63+<email>BlAfugRpC6u6w@public.gmane.org</email>

</footer></body></message>