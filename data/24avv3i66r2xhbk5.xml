<message message-id="1276271509-11983-7-git-send-email-felipe.contreras@gmail.com" list="org.kernel.vger.linux-omap" id="24avv3i66r2xhbk5" type="development" date="2010-06-11T18:51:41+03:00" year="2010-01-01" year-month="2010-06-01" year-month-day="2010-06-11" thread-id="fp6zelygdae5cigw"><headers><envelope-from-line>Fri Jun 11 07:52:35 2010</envelope-from-line><from personal="Felipe Contreras" address="felipe.contreras@gmail.com">Felipe Contreras &lt;felipe.contreras@gmail.com&gt;</from><to personal="linux-omap" address="linux-omap@vger.kernel.org">linux-omap &lt;linux-omap@vger.kernel.org&gt;</to><cc personal="linux-arm" address="linux-arm-kernel@lists.infradead.org">linux-arm &lt;linux-arm-kernel@lists.infradead.org&gt;</cc><subject normal="[PATCH v4 06/14] omap: mailbox: update omap1 probing">[PATCH v4 06/14] omap: mailbox: update omap1 probing</subject><received>from srv-117c-be06.markmail.marklogic.com ([172.19.8.46])
          by mail-1.a.markmail.int (JAMES SMTP Server 2.3.1) with SMTP ID 978
          for &lt;archive.user.50559@a.markmail.org&gt;;
          Fri, 11 Jun 2010 07:52:35 -0800 (GMT-08:00)</received><received>from vger.kernel.org (slb-117n.markmail.marklogic.com [172.19.8.33])
	by mgw-1.public.markmail.int (Postfix) with ESMTP id 5B9E22908236
	for &lt;archive.user.50559@a.markmail.org&gt;; Fri, 11 Jun 2010 08:52:12 -0700 (PDT)</received><received>(majordomo@vger.kernel.org) by vger.kernel.org via listexpand
	id S1757970Ab0FKPwe (ORCPT
	&lt;rfc822;archive.user.50559@a.markmail.org&gt;);
	Fri, 11 Jun 2010 11:52:34 -0400</received><received>from mail-wy0-f174.google.com ([74.125.82.174]:60624 "EHLO
	mail-wy0-f174.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
	with ESMTP id S1757728Ab0FKPwe (ORCPT
	&lt;rfc822;linux-omap@vger.kernel.org&gt;); Fri, 11 Jun 2010 11:52:34 -0400</received><received>by mail-wy0-f174.google.com with SMTP id 40so896647wyb.19
        for &lt;linux-omap@vger.kernel.org&gt;; Fri, 11 Jun 2010 08:52:33 -0700 (PDT)</received><dkim-signature>v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=gamma;
        h=domainkey-signature:received:received:from:to:cc:subject:date
         :message-id:x-mailer:in-reply-to:references;
        bh=sGS+gvRmihXgrN4beNxqMSXkQNU0J9ur6+rbH2Bb8HM=;
        b=VvV5hRrYXxUhEWaWr9VjymYI9OfCrcASQWA1g2gPTI8V1osPKx72h8tSrvRkQ0eyC3
         t8tv2URlrFQS5EyY+UgML7UgUE0w8gzpzZ/AqcGRzL+gLqyRbz+pCz0U/bIRruwl3zfy
         9Wsjm1uVaKsYUxyWEYbqkeb8dAm8NrhKcunmk=</dkim-signature><domainkey-signature>a=rsa-sha1; c=nofws;
        d=gmail.com; s=gamma;
        h=from:to:cc:subject:date:message-id:x-mailer:in-reply-to:references;
        b=lfiSX952v8K+HFiGJSRUd8hNJi0MmMbWKdq3WbxW6BELk5KtTsdjyqEvqkSoZAbeaV
         RsgeZinO5C/1M4eYjXNagmGigu3s5nlQZ1UPRzf8UUwlbCB/5PbjE66VaDrc32XmdW9h
         B2Z8sCRBpP2JGKj30K/cKZZ1KIKxbi0QxTLCY=</domainkey-signature><received>by 10.227.137.69 with SMTP id v5mr2034759wbt.208.1276271553272;
        Fri, 11 Jun 2010 08:52:33 -0700 (PDT)</received><received>from localhost ([192.100.124.156])
        by mx.google.com with ESMTPS id d75sm608882wek.32.2010.06.11.08.52.32
        (version=TLSv1/SSLv3 cipher=RC4-MD5);
        Fri, 11 Jun 2010 08:52:32 -0700 (PDT)</received><date>Fri, 11 Jun 2010 18:51:41 +0300</date><message-id>1276271509-11983-7-git-send-email-felipe.contreras@gmail.com</message-id><x-mailer>git-send-email 1.7.1</x-mailer><in-reply-to>&lt;1276271509-11983-1-git-send-email-felipe.contreras@gmail.com&gt;</in-reply-to><references>&lt;1276271509-11983-1-git-send-email-felipe.contreras@gmail.com&gt;</references><sender>linux-omap-owner@vger.kernel.org</sender><precedence>bulk</precedence><list-id>&lt;linux-omap.vger.kernel.org&gt;</list-id><x-mailing-list>linux-omap@vger.kernel.org</x-mailing-list></headers><normalized-references><normalized-message-id>1276271509-11983-7-git-send-email-felipe.contreras@gmail.com</normalized-message-id><normalized-in-reply-to>1276271509-11983-1-git-send-email-felipe.contreras@gmail.com</normalized-in-reply-to><normalized-reference>1276271509-11983-1-git-send-email-felipe.contreras@gmail.com</normalized-reference></normalized-references><body type="text/plain"><para depth="0">Based on omap2 code.

</para><para depth="0">Signed-off-by: Felipe Contreras &lt;<email>felipe.contreras@gmail.com</email>&gt;
</para><para depth="0">---
 arch/arm/mach-omap1/mailbox.c |   28 ++++++++++++++--------------
 1 files changed, 14 insertions(+), 14 deletions(-)

</para><para depth="0">diff --git a/arch/arm/mach-omap1/mailbox.c b/arch/arm/mach-omap1/mailbox.c
index 15bf2a2..211b9fc 100644
--- a/arch/arm/mach-omap1/mailbox.c
+++ b/arch/arm/mach-omap1/mailbox.c
@@ -146,12 +146,7 @@ EXPORT_SYMBOL(mbox_dsp_info);
 static int __devinit omap1_mbox_probe(struct platform_device *pdev)
 {
 	struct resource *res;
-
-	if (pdev-&gt;num_resources != 2) {
-		dev_err(&amp;pdev-&gt;dev, "invalid number of resources: %d\n",
-			pdev-&gt;num_resources);
-		return -ENODEV;
-	}
+	int ret;

</para><para depth="0"> 	/* MBOX base */
 	res = platform_get_resource(pdev, IORESOURCE_MEM, 0);
@@ -161,27 +156,32 @@ static int __devinit omap1_mbox_probe(struct<br/>platform_device *pdev)
 	}

</para><para depth="0"> 	mbox_base = ioremap(res-&gt;start, resource_size(res));
-	if (!mbox_base) {
-		dev_err(&amp;pdev-&gt;dev, "ioremap failed\n");
-		return -ENODEV;
-	}
+	if (!mbox_base)
+		return -ENOMEM;

</para><para depth="0"> 	/* DSP IRQ */
 	res = platform_get_resource(pdev, IORESOURCE_IRQ, 0);
 	if (unlikely(!res)) {
 		dev_err(&amp;pdev-&gt;dev, "invalid irq resource\n");
-		iounmap(mbox_base);
-		return -ENODEV;
+		ret = -ENODEV;
+		goto err_out;
 	}
 	mbox_dsp_info.irq = res-&gt;start;

</para><para depth="0">-	return omap_mbox_register(&amp;pdev-&gt;dev, &amp;mbox_dsp_info);
+	ret = omap_mbox_register(&amp;pdev-&gt;dev, &amp;mbox_dsp_info);
+	if (ret)
+		goto err_out;
+	return 0;
+
+err_out:
+	iounmap(mbox_base);
+	return ret;
 }

</para><para depth="0"> static int __devexit omap1_mbox_remove(struct platform_device *pdev)
 {
 	omap_mbox_unregister(&amp;mbox_dsp_info);
-
+	iounmap(mbox_base);
 	return 0;
 }

</para><footer type="signature" depth="0" hash="17453987520883910942">-- 
1.7.1

</footer><footer type="list-management" depth="0">--
To unsubscribe from this list: send the line "unsubscribe linux-omap" in
the body of a message to <email>majordomo@vger.kernel.org</email>
More majordomo info at  <url>http://vger.kernel.org/majordomo-info.html</url>
</footer></body></message>