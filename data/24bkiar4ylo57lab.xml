<message message-id="40F398F58302D411B1D80010B5458F143FA6A7@mtiserver1.sfcommerce.com" list="org.apache.tomcat.users" id="24bkiar4ylo57lab" type="users" date="2000-07-28T13:22:23-04:00" year="2000-01-01" year-month="2000-07-01" year-month-day="2000-07-28" thread-id="fcrgp2ny3nnu3ia6"><headers><envelope-from-line>From TurnerM@sfcommerce.com  Fri Jul 28 17:21:18 2000</envelope-from-line><from personal="Maxime Turner" address="TurnerM@sfcommerce.com">Maxime Turner &lt;TurnerM@sfcommerce.com&gt;</from><to personal="'tomcat-user@jakarta.apache.org'" address="tomcat-user@jakarta.apache.org">"'tomcat-user@jakarta.apache.org'" &lt;tomcat-user@jakarta.apache.org&gt;</to><subject normal="load-on-startup servlet being initialised twice">RE: load-on-startup servlet being initialised twice</subject><return-path>TurnerM@sfcommerce.com</return-path><mailing-list>contact tomcat-user-help@jakarta.apache.org; run by ezmlm</mailing-list><delivered-to>mailing list tomcat-user@jakarta.apache.org</delivered-to><received>(qmail 93999 invoked from network); 28 Jul 2000 17:21:18 -0000</received><received>from unknown (HELO mtiserver1.sfcommerce.com) (205.205.62.92)
  by locus.apache.org with SMTP; 28 Jul 2000 17:21:18 -0000</received><received>by mtiserver1.sfcommerce.com with Internet Mail Service (5.5.2232.9)
	id &lt;PFCM3ZL6&gt;; Fri, 28 Jul 2000 13:22:24 -0400</received><message-id>40F398F58302D411B1D80010B5458F143FA6A7@mtiserver1.sfcommerce.com</message-id><date>Fri, 28 Jul 2000 13:22:23 -0400</date><mime-version>1.0</mime-version><x-mailer>Internet Mail Service (5.5.2232.9)</x-mailer><content-type>multipart/alternative;
	boundary="----_=_NextPart_001_01BFF8B8.650C8FFA"</content-type><x-spam-rating>locus.apache.org 1.6.2 0/1000/N</x-spam-rating></headers><normalized-references><normalized-message-id>40F398F58302D411B1D80010B5458F143FA6A7@mtiserver1.sfcommerce.com</normalized-message-id></normalized-references><body multipart="multipart/alternative;&#13;&#10;&#9;boundary=&quot;----_=_nextpart_001_01bff8b8.650c8ffa&quot;" type="text/plain;&#13;&#10;&#9;charset=&quot;windows-1252&quot;"><para depth="0">I also had that problem, and it was because i defined my servlet in the main
web.xml (the one in TOMCAT-HOME/conf) but it looks like it loaded the
servlet for each of the context define in my server.xml. So what i did is
define servlet only in the /WEB-INF/web.xml of the web application i need
the servlet in. So now it load it up only once at startup.

</para><quote depth="1"><quotepara depth="1">-----Original Message-----
From: Rachel Greenham [mailto:<email>rachel.greenham@enetgroup.co.uk</email>]
Sent: Friday, July 28, 2000 1:08 PM
To: <email>tomcat-user@jakarta.apache.org</email>
Subject: load-on-startup servlet being initialised twice

</quotepara><quotepara depth="1">... it looks like a Tomcat bug:

</quotepara><quotepara depth="1">Platform: SuSE Linux 6.4 kernel 2.2.16, SUN JDK-SE 1.2.2 
(green threads,
nojit), Jakarta-Tomcat 3.1.

</quotepara><quotepara depth="1">We're in the process of porting our quite large web 
application from the old
Servlet 2.0 based Apache JServ up to run on Tomcat. Things 
are going well -
but we have a servlet that needs to be initialised on 
startup, so I've put a
&lt;servlet&gt; tag into the WEB_INF/web.xml file, and put a
&lt;load-on-startup&gt;1&lt;/load-on-startup&gt; in there.

</quotepara><quotepara depth="1">It does start... but twice. In fact, I then put a check in to 
try to force
it not to initialise twice, like this:

</quotepara><quotepara depth="1">public class StartupServlet extends HttpServlet
{
	private boolean initrun = false;

</quotepara><quotepara depth="1">	public void init(ServletConfig config) throws 
ServletException // keeping
JSDK2.0 compatibility for now
	{
		if (initrun) return;
		super.init();
		System.out.println("We're off!");
		initrun = true;
	}
}

</quotepara><quotepara depth="1">And given that, the body of the init method is still being 
run, ie: we get
"We're off" twice, so it looks like the servlet class is 
actually being
instantiated twice, with a resultant resource-leak. The site 
then proceeds
to run normally, but it's clearly not right, is it?

</quotepara><quotepara depth="1">It didn't do this under JSDK2.0, and I put a stack trace into 
this method,
and it's definitely getting called by Tomcat itself in 
exactly the same way
each time, not getting called again by our own code. ie, this:

</quotepara><quotepara depth="1">public class StartupServlet extends HttpServlet
{
	private boolean initrun = false;

</quotepara><quotepara depth="1">	public void init(ServletConfig config) throws 
ServletException // keeping
JSDK2.0 compatibility for now
	{
		if (initrun) return;
		super.init();
		Exception e = new Exception("wibble");
		e.printStackTrace();
		// too lazy to learn a neater way :-)
		System.out.println("We're off!"); // not the real code
		initrun = true;
	}
}

</quotepara><quotepara depth="1">produces this, regardless of the initrun stuff:

</quotepara><quotepara depth="1">Starting tomcat. Check logs/tomcat.log for error messages
java.lang.Exception: wibble
        at
com.enetsoftware.esparto.servlets.StartupServlet.init(StartupS
ervlet.java:73)
        at
org.apache.tomcat.core.ServletWrapper.initServlet(ServletWrapp
er.java:315)
        at
org.apache.tomcat.core.ServletWrapper.loadServlet(ServletWrapp
er.java:276)
        at
org.apache.tomcat.context.LoadOnStartupInterceptor.contextInit
(LoadOnStartupInterceptor.java:132)
        at
org.apache.tomcat.core.ContextManager.initContext(ContextManag
er.java:227)
        at
org.apache.tomcat.core.ContextManager.init(ContextManager.java:201)
        at org.apache.tomcat.startup.Tomcat.execute(Tomcat.java:156)
        at org.apache.tomcat.startup.Tomcat.main(Tomcat.java:163)
Fri Jul 28 17:34:20 GMT+01:00 2000 Esparto started
memory usage: 68343104 free / 83886072 total
java.lang.Exception: wibble
        at
com.enetsoftware.esparto.servlets.StartupServlet.init(StartupS
ervlet.java:73)
        at
org.apache.tomcat.core.ServletWrapper.initServlet(ServletWrapp
er.java:315)
        at
org.apache.tomcat.core.ServletWrapper.loadServlet(ServletWrapp
er.java:276)
        at
org.apache.tomcat.context.LoadOnStartupInterceptor.contextInit
(LoadOnStartupInterceptor.java:132)
        at
org.apache.tomcat.core.ContextManager.initContext(ContextManag
er.java:227)
        at
org.apache.tomcat.core.ContextManager.init(ContextManager.java:201)
        at org.apache.tomcat.startup.Tomcat.execute(Tomcat.java:156)
        at org.apache.tomcat.startup.Tomcat.main(Tomcat.java:163)
Fri Jul 28 17:34:22 GMT+01:00 2000 Esparto started
memory usage: 67292512 free / 83886072 total
rachel@pell:~/esparto/esparto2 &gt; ~/jakarta-tomcat/bin/tomcat.sh stop

</quotepara><quotepara depth="1">Is it a bug in Tomcat?

</quotepara><quotepara depth="1">By the way, if you don't give a number to &lt;load-on-startup&gt; 
(ie: you give
&lt;load-on-startup /&gt;) you get NumberFormatExceptions on 
startup, whereas the
Sun spec says that the number is optional.

</quotepara><quotefooter type="signature" hash="10002902736805036562" depth="1">-- 
Rachel

</quotefooter></quote></body></message>