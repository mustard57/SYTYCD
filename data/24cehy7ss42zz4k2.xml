<message message-id="1207347218.545071.28941.nullmailer@svn.kde.org" list="org.kde.kde-commits" id="24cehy7ss42zz4k2" type="checkins" date="2008-04-04T22:13:38Z" year="2008-01-01" year-month="2008-04-01" year-month-day="2008-04-04" thread-id="beoj2zqgicgudmn7"><headers><envelope-from-line>From nntpsnarfer@fakefrom.com  Mon Jan  1 12:00:00 1990</envelope-from-line><from personal="Gaël de Chalendar" address="kleag@free.fr">=?utf-8?q?Ga=C3=ABl=20de=20Chalendar?= &lt;kleag@free.fr&gt;</from><to personal="kde-commits@kde.org" address="kde-commits@kde.org">kde-commits@kde.org</to><subject normal="playground/games/ksirk/ksirk">playground/games/ksirk/ksirk</subject><path>news.gmane.org!not-for-mail</path><newsgroups>gmane.comp.kde.cvs</newsgroups><date>Fri, 04 Apr 2008 22:13:38 +0000</date><lines>238</lines><approved>news@gmane.org</approved><message-id>1207347218.545071.28941.nullmailer@svn.kde.org</message-id><reply-to>kde-commits@kde.org</reply-to><nntp-posting-host>lo.gmane.org</nntp-posting-host><mime-version>1.0</mime-version><content-type>text/plain; charset=UTF-8</content-type><content-transfer-encoding>8bit</content-transfer-encoding><x-trace>ger.gmane.org 1207347235 9993 80.91.229.12 (4 Apr 2008 22:13:55 GMT)</x-trace><x-complaints-to>usenet@ger.gmane.org</x-complaints-to><nntp-posting-date>Fri, 4 Apr 2008 22:13:55 +0000 (UTC)</nntp-posting-date><original-x-from>kde-commits-bounces-+gckc-kde-cvs=m.gmane.org@kde.org Sat Apr 05 00:14:24 2008</original-x-from><return-path>kde-commits-bounces-+gckc-kde-cvs=m.gmane.org@kde.org</return-path><envelope-to>gckc-kde-cvs@gmane.org</envelope-to><original-received>from ktown.kde.org ([131.246.120.250])
	by lo.gmane.org with smtp (Exim 4.50)
	id 1JhuAx-0007Uu-1Q
	for gckc-kde-cvs@gmane.org; Sat, 05 Apr 2008 00:14:23 +0200</original-received><original-received>(qmail 28371 invoked by uid 72); 4 Apr 2008 22:14:04 -0000</original-received><original-received>(qmail 28365 invoked from network); 4 Apr 2008 22:14:02 -0000</original-received><x-spam-checker-version>SpamAssassin 3.2.3 (2007-08-08) on ktown.kde.org</x-spam-checker-version><original-received>from unknown (HELO office.kde.org) (195.135.221.67)
	by ktown.kde.org with SMTP; 4 Apr 2008 22:14:01 -0000</original-received><original-received>from svn.kde.org (localhost [127.0.0.1])
	by office.kde.org (Postfix) with SMTP id 9278C581
	for &lt;kde-commits@kde.org&gt;; Sat,  5 Apr 2008 00:13:38 +0200 (CEST)</original-received><original-received>(nullmailer pid 28942 invoked by uid 50633);
	Fri, 04 Apr 2008 22:13:38 -0000</original-received><x-commit-directories>(0) trunk/playground/games/ksirk/ksirk
	trunk/playground/games/ksirk/ksirk/Dialogs
	trunk/playground/games/ksirk/ksirk/GameLogic
	trunk/playground/games/ksirk/ksirk/SaveLoad
	trunk/playground/games/ksirk/ksirk/Sprites</x-commit-directories><x-beenthere>kde-commits@kde.org</x-beenthere><x-mailman-version>2.1.9</x-mailman-version><precedence>list</precedence><list-id>Notification of KDE commits &lt;kde-commits.kde.org&gt;</list-id><list-unsubscribe>&lt;https://mail.kde.org/mailman/listinfo/kde-commits&gt;,
	&lt;mailto:kde-commits-request@kde.org?subject=unsubscribe&gt;</list-unsubscribe><list-post>&lt;mailto:kde-commits@kde.org&gt;</list-post><list-help>&lt;mailto:kde-commits-request@kde.org?subject=help&gt;</list-help><list-subscribe>&lt;https://mail.kde.org/mailman/listinfo/kde-commits&gt;,
	&lt;mailto:kde-commits-request@kde.org?subject=subscribe&gt;</list-subscribe><xref>news.gmane.org gmane.comp.kde.cvs:623856</xref><archived-at>&lt;http://permalink.gmane.org/gmane.comp.kde.cvs/623856&gt;</archived-at></headers><normalized-references><normalized-message-id>1207347218.545071.28941.nullmailer@svn.kde.org</normalized-message-id></normalized-references><body type="text/plain; charset=utf-8"><para depth="0">SVN commit 793731 by kleag:

</para><para depth="0">- Changed the saving of network players to allow empty passwords;
- corrected loading of waited network players;
- corrected the initialization of the world after joining a network game;
current problem: saved network games are not well initialized at load time

</para><para depth="0"> M  +1 -6      Dialogs/kwaitedplayersetupdialog.cpp  
 M  +1 -2      GameLogic/country.cpp  
 M  +3 -2      GameLogic/gameautomaton.cpp  
 M  +3 -2      GameLogic/goal.h  
 M  +1 -1      GameLogic/onu.cpp  
 M  +1 -0      GameLogic/player.cpp  
 M  +1 -0      GameLogic/player.h  
 M  +1 -1      KsirkGlobalDefinitions.h  
 M  +5 -2      SaveLoad/ksirkgamexmlhandler.cpp  
 M  +6 -6      Sprites/animspritesgroup.cpp  
 M  +3 -1      fightArena.cpp  
 M  +2 -1      kgamewin.cpp  

</para><para depth="0">--- trunk/playground/games/ksirk/ksirk/Dialogs/kwaitedplayersetupdialog.cpp<br/>#793730:793731
@@ -86,12 +86,7 @@
   for (; it != it_end; it++)
   {
     kDebug() &lt;&lt; "Adding waited player " &lt;&lt; (*it).name &lt;&lt; endl;
-    QString imgName = m_dirs-&gt; findResource("appdata", m_automaton-&gt;skin() +<br/>"/Images/sprites/" +<br/>m_automaton-&gt;game()-&gt;theWorld()-&gt;nationNamed((*it).nation)-&gt;flagFileName());
-    if (imgName.isNull())
-    {
-      KMessageBox::error(0, i18n("Flag image resource not found\nProgram cannot<br/>continue"), i18n("Error !"));
-        exit(2);
-    }
+    QString imgName =<br/>m_automaton-&gt;game()-&gt;theWorld()-&gt;nationNamed((*it).nation)-&gt;flagFileName();
 //     load image
     QPixmap flag;
     QSize<br/>size(flag.width()/Sprites::SkinSpritesData::single().intData("flag-frames"),flag.height());
--- trunk/playground/games/ksirk/ksirk/GameLogic/country.cpp #793730:793731
@@ -465,8 +465,7 @@

</para><para depth="0"> void Country::send(QDataStream&amp; stream)
 {
-  
-stream &lt;&lt; m_name &lt;&lt; (m_belongsTo?m_belongsTo-&gt;name():"") &lt;&lt; quint32(m_nbArmies)<br/>&lt;&lt; quint32(m_nbAddedArmies);
+  stream &lt;&lt; m_name &lt;&lt; (m_belongsTo?m_belongsTo-&gt;name():"") &lt;&lt;<br/>quint32(m_nbArmies) &lt;&lt; quint32(m_nbAddedArmies);
 }

</para><para depth="0"> bool Country::hasAdjacentEnemy()
--- trunk/playground/games/ksirk/ksirk/GameLogic/gameautomaton.cpp<br/>#793730:793731
@@ -1750,6 +1750,7 @@
   {
     kDebug() &lt;&lt; "skin changed to: " &lt;&lt; m_skin &lt;&lt; endl;
     m_game-&gt;newSkin();
+    m_game-&gt;theWorld()-&gt;reset();
   }
   kDebug() &lt;&lt; "END GameAutomaton::slotPropertyChanged " &lt;&lt; prop-&gt;id() &lt;&lt; "<br/>(skin is " &lt;&lt; m_skinId &lt;&lt; ")" &lt;&lt; endl;
 }
@@ -1867,7 +1868,7 @@
   KMessageParts messageParts;
   QString messagePart;
   Player* player;
-  PlayerMatrix waitedPlayerDef;
+  PlayerMatrix waitedPlayerDef(this);
   quint32 nbWaitedPlayers;
   quint32 waitedPlayerId;
   QString waitedPlayerPassword;
@@ -2290,7 +2291,7 @@
     {
       stream &gt;&gt; countryName;
       country = m_game-&gt;theWorld()-&gt;countryNamed(countryName);
-//       kDebug() &lt;&lt; "Setting up country n°" &lt;&lt; i &lt;&lt; " on " &lt;&lt; nbCountries &lt;&lt;<br/>", " &lt;&lt; country &lt;&lt; " named " &lt;&lt; countryName &lt;&lt; endl;
+      kDebug() &lt;&lt; "Setting up country n°" &lt;&lt; i &lt;&lt; " on " &lt;&lt; nbCountries &lt;&lt; ", "<br/>&lt;&lt; (void*)country &lt;&lt; " named " &lt;&lt; countryName &lt;&lt; endl;
       if (country)
       {
         stream &gt;&gt; country;
--- trunk/playground/games/ksirk/ksirk/GameLogic/goal.h #793730:793731
@@ -59,8 +59,6 @@
     GoalAdvance = 2 /**&lt; The advance step. */
   };

</para><para depth="0">-  /** Default constructor */
-  Goal();
   Goal(GameAutomaton* automaton);

</para><para depth="0">   /** Copy constructor */
@@ -162,6 +160,9 @@

</para><para depth="0">   GameAutomaton* m_automaton;
   private:
+    /** Default constructor */
+  Goal();
+
   GoalType m_type;
   QString m_description;
   unsigned int m_nbCountries;
--- trunk/playground/games/ksirk/ksirk/GameLogic/onu.cpp #793730:793731
@@ -280,7 +280,7 @@
   {
     KConfigGroup goalGroup = config.group(goal);

</para><para depth="0">-    Goal* goal = new Goal();
+    Goal* goal = new Goal(automaton);
     goal-&gt;description(goalGroup.readEntry("desc",""));
     QString goalType = goalGroup.readEntry("type","");
     if (goalType == "countries")
--- trunk/playground/games/ksirk/ksirk/GameLogic/player.cpp #793730:793731
@@ -216,6 +216,7 @@
   nationName = nationName.replace("&gt;","&amp;gt;");
   xmlStream &lt;&lt; " nation=\"" &lt;&lt; nationName.toUtf8().data() &lt;&lt; "\"";
   xmlStream &lt;&lt; " password=\"" &lt;&lt; m_password.value().toUtf8().data() &lt;&lt; "\"";
+  xmlStream &lt;&lt; " local=\"" &lt;&lt; (isVirtual()?"false":"true") &lt;&lt; "\"";
 }

</para><para depth="0"> bool   Player::load (QDataStream &amp;stream)
--- trunk/playground/games/ksirk/ksirk/GameLogic/player.h #793730:793731
@@ -257,6 +257,7 @@
   */
 struct PlayerMatrix
 {
+  PlayerMatrix(GameLogic::GameAutomaton* automaton): goal(automaton){}

</para><para depth="0">   QString name;

</para><para depth="0">--- trunk/playground/games/ksirk/ksirk/KsirkGlobalDefinitions.h #793730:793731
@@ -25,7 +25,7 @@
 #define KSIRK_GLOBAL_H

</para><para depth="0"> #define ONU_FILE_FORMAT_VERSION "2.0"
-#define SAVE_GAME_FILE_FORMAT_VERSION "1.5"
+#define SAVE_GAME_FILE_FORMAT_VERSION "1.6"

</para><para depth="0"> #define ID_NO_STATUS_MSG 0
 #define ID_STATUS_MSG 1
--- trunk/playground/games/ksirk/ksirk/SaveLoad/ksirkgamexmlhandler.cpp<br/>#793730:793731
@@ -117,7 +117,10 @@

</para><para depth="0">     QString password = atts.value("password");

</para><para depth="0">-    if (password.isEmpty())
+    bool isLocal = true; // local player by default
+    if (atts.value("local") == "false") isLocal = false;
+
+    if (isLocal)
     {
       kDebug() &lt;&lt; "Adding the read player " &lt;&lt; name &lt;&lt; endl;
       m_game.addPlayer(name, nbAvailArmies, nbCountries, nationName,
@@ -125,7 +128,7 @@
     }
     else
     {
-      PlayerMatrix pm;
+      PlayerMatrix pm(m_game.automaton());
       pm.name = name;
       pm.nbAttack = nbAttack;
       pm.nbCountries = nbCountries;
--- trunk/playground/games/ksirk/ksirk/Sprites/animspritesgroup.cpp<br/>#793730:793731
@@ -28,7 +28,7 @@
 AnimSpritesGroup::AnimSpritesGroup(QObject* target, const char* slot):
   m_numberArrived(0), m_target(target), m_slot(slot)
 {
-  kDebug() &lt;&lt; endl;
+  kDebug();
   connect (this,SIGNAL(arrived(AnimSpritesGroup*)),target,slot);
 }

</para><para depth="0">@@ -38,7 +38,7 @@

</para><para depth="0"> void AnimSpritesGroup::changeTarget(QObject* target, const char* slot)
 {
-  kDebug() &lt;&lt; endl;
+  kDebug();
   if (m_target != 0)
   {
     disconnect(this,SIGNAL(arrived(AnimSpritesGroup*)),m_target,m_slot);
@@ -50,7 +50,7 @@

</para><para depth="0"> void AnimSpritesGroup::clear()
 {
-  kDebug() &lt;&lt; endl;
+  kDebug();
   disconnect(this,SIGNAL(arrived(AnimSpritesGroup*)),m_target,m_slot);
   m_target = 0; 
   m_slot = 0;
@@ -61,6 +61,7 @@

</para><para depth="0"> void AnimSpritesGroup::addSprite(AnimSprite* sprite)
 {
+  kDebug();
   push_back(sprite);
   connect(sprite,<br/>SIGNAL(atDestination(AnimSprite*)),this,SLOT(oneArrived(AnimSprite*)));
   connect(sprite,<br/>SIGNAL(animationFinished(AnimSprite*)),this,SLOT(oneArrived(AnimSprite*)));
@@ -69,15 +70,14 @@
 void AnimSpritesGroup::oneArrived(AnimSprite* sprite)
 {
   m_numberArrived++;
-  kDebug() &lt;&lt; m_numberArrived 
-    &lt;&lt; " on " &lt;&lt; size() &lt;&lt; endl;
+  kDebug() &lt;&lt; m_numberArrived &lt;&lt; " on " &lt;&lt; AnimSpritesList&lt;AnimSprite&gt;::size();
   // if 0 is given, then one is count as arrived whithout action. Useful for 
   // non-animated sprites of the group, but ugly solution...
   if (sprite != 0)
   {
     sprite-&gt;arrival();
   }
-  if (m_numberArrived == (unsigned int)size())
+  if (m_numberArrived == (unsigned int)AnimSpritesList&lt;AnimSprite&gt;::size())
   {
     emit arrived(this);
     m_numberArrived = 0;
--- trunk/playground/games/ksirk/ksirk/fightArena.cpp #793730:793731
@@ -25,7 +25,9 @@
 {
    using namespace GameLogic;

</para><para depth="0">-   FightArena::FightArena(QWidget* parent, unsigned int mapW, unsigned int<br/>mapH, QGraphicsScene* sceneArena,ONU* onuObject, GameAutomaton* automaton):
+   FightArena::FightArena(QWidget* parent, unsigned int mapW, unsigned int<br/>mapH,
+      QGraphicsScene* sceneArena,ONU* onuObject, GameAutomaton* automaton):
+   QGraphicsView(parent),
    m_scene(sceneArena),
    m_onu(onuObject),
    m_automaton(automaton)
--- trunk/playground/games/ksirk/ksirk/kgamewin.cpp #793730:793731
@@ -2192,13 +2192,14 @@
 bool KGameWindow::playerPutsInitialArmy(const QPointF&amp; point)
 {
   {
-    kDebug() &lt;&lt; "KGameWindow::playerPutsInitialArmy " &lt;&lt; point;
+    kDebug() &lt;&lt; point;
     Country* clickedCountry = clickIn(point);

</para><para depth="0">     if ( (clickedCountry) )
     {
       kDebug() &lt;&lt; "clickedCountry name=" &lt;&lt; clickedCountry-&gt;name() ;
       kDebug() &lt;&lt; "clickedCountry owner=" &lt;&lt; clickedCountry-&gt; owner()-&gt;name();
+      kDebug() &lt;&lt; "clickedCountry had armies=" &lt;&lt; clickedCountry-&gt; nbArmies();
       kDebug() &lt;&lt; "currentPlayer=" &lt;&lt; currentPlayer()-&gt;name();
       kDebug() &lt;&lt; "m_nbAvailArmies=" &lt;&lt; m_nbAvailArmies;

</para></body></message>