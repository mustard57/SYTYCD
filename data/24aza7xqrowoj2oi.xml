<message message-id="1268254688.73.0.785894514771.issue2086@mercurial.selenic.com" list="com.selenic.mercurial-devel" id="24aza7xqrowoj2oi" type="development" date="2010-03-10T20:58:08Z" year="2010-01-01" year-month="2010-03-01" year-month-day="2010-03-10" thread-id="24aza7xqrowoj2oi"><headers><envelope-from-line>Wed Mar 10 12:58:34 2010</envelope-from-line><from personal="Glenn Hutchings" address="bugs@mercurial.selenic.com">Glenn Hutchings &lt;bugs@mercurial.selenic.com&gt;</from><to personal="mercurial-devel@selenic.com" address="mercurial-devel@selenic.com">mercurial-devel@selenic.com</to><subject normal="[issue2086] Problem setting default path when cloning from local-file scheme">[issue2086] Problem setting default path when cloning from local-file scheme</subject><received>from srv-117c-be06.markmail.marklogic.com ([172.19.8.46])
          by mail-1.a.markmail.int (JAMES SMTP Server 2.3.1) with SMTP ID 954
          for &lt;whitney.todd.huber@a.markmail.org&gt;;
          Wed, 10 Mar 2010 12:58:34 -0800 (GMT-08:00)</received><received>from waste.org (slb-117n.markmail.marklogic.com [172.19.8.33])
	by mgw-1.public.markmail.int (Postfix) with ESMTP id B2D3229082C5
	for &lt;whitney.todd.huber@a.markmail.org&gt;; Wed, 10 Mar 2010 12:58:10 -0800 (PST)</received><received>from localhost (localhost [127.0.0.1])
	by waste.org (Postfix) with ESMTP id B4D3B74593;
	Wed, 10 Mar 2010 14:58:32 -0600 (CST)</received><x-virus-scanned>Debian amavisd-new at waste.org</x-virus-scanned><received>from waste.org ([127.0.0.1])
	by localhost (waste.org [127.0.0.1]) (amavisd-new, port 10024)
	with LMTP id uQbkhSAkFdZM; Wed, 10 Mar 2010 14:58:29 -0600 (CST)</received><received>from waste.org (localhost [127.0.0.1])
	by waste.org (Postfix) with ESMTP id ACF6274589;
	Wed, 10 Mar 2010 14:58:27 -0600 (CST)</received><x-original-to>mercurial-devel@waste.org</x-original-to><delivered-to>mercurial-devel@waste.org</delivered-to><received>from localhost (localhost [127.0.0.1])
	by waste.org (Postfix) with ESMTP id 6E5F07453B
	for &lt;mercurial-devel@waste.org&gt;; Wed, 10 Mar 2010 14:58:18 -0600 (CST)</received><x-virus-scanned>Debian amavisd-new at waste.org</x-virus-scanned><received>from waste.org ([127.0.0.1])
	by localhost (waste.org [127.0.0.1]) (amavisd-new, port 10024)
	with LMTP id BnnZDtCNd-y7 for &lt;mercurial-devel@waste.org&gt;;
	Wed, 10 Mar 2010 14:58:15 -0600 (CST)</received><received>from mercurial.selenic.com
	(173-11-57-243-Minnesota.hfc.comcastbusiness.net [173.11.57.243])
	by waste.org (Postfix) with ESMTP id 1A54A7458D
	for &lt;mercurial-devel@selenic.com&gt;; Wed, 10 Mar 2010 14:58:10 -0600 (CST)</received><received>from [10.0.1.4] (localhost.localdomain [127.0.0.1])
	by mercurial.selenic.com (Postfix) with ESMTP id BB971624B
	for &lt;mercurial-devel@selenic.com&gt;; Wed, 10 Mar 2010 14:58:08 -0600 (CST)</received><content-type>multipart/mixed; boundary="===============8653109479197988657=="</content-type><mime-version>1.0</mime-version><date>Wed, 10 Mar 2010 20:58:08 +0000</date><precedence>bulk</precedence><x-roundup-name>Mercurial issue tracker</x-roundup-name><x-roundup-loop>hello</x-roundup-loop><x-roundup-version>1.4.10</x-roundup-version><message-id>1268254688.73.0.785894514771.issue2086@mercurial.selenic.com</message-id><x-roundup-issue-status>unread</x-roundup-issue-status><x-roundup-issue-priority>bug</x-roundup-issue-priority><x-roundup-issue-files>file-scheme-bug.patch</x-roundup-issue-files><in-reply-to>&lt;1268254688.73.0.785894514771.issue2086@mercurial.selenic.com&gt;</in-reply-to><x-beenthere>mercurial-devel@selenic.com</x-beenthere><x-mailman-version>2.1.11</x-mailman-version><reply-to>Mercurial issue tracker &lt;bugs@mercurial.selenic.com&gt;</reply-to><list-id>&lt;mercurial-devel.selenic.com&gt;</list-id><list-unsubscribe>&lt;http://selenic.com/mailman/options/mercurial-devel&gt;,
	&lt;mailto:mercurial-devel-request@selenic.com?subject=unsubscribe&gt;</list-unsubscribe><list-archive>&lt;http://selenic.com/pipermail/mercurial-devel&gt;</list-archive><list-post>&lt;mailto:mercurial-devel@selenic.com&gt;</list-post><list-help>&lt;mailto:mercurial-devel-request@selenic.com?subject=help&gt;</list-help><list-subscribe>&lt;http://selenic.com/mailman/listinfo/mercurial-devel&gt;,
	&lt;mailto:mercurial-devel-request@selenic.com?subject=subscribe&gt;</list-subscribe><sender>mercurial-devel-bounces@selenic.com</sender><errors-to>mercurial-devel-bounces@selenic.com</errors-to></headers><attachments><attachment type="text/x-diff" file="file-scheme-bug.patch" size="1446" uri="/24aza7xqrowoj2oi/attach00/file-scheme-bug.patch" extension="patch"><page page="1"><attachpara>schemes: fix default path setting when cloning from local file schemes

diff --git a/mercurial/hg.py b/mercurial/hg.py
--- a/mercurial/hg.py
+++ b/mercurial/hg.py
@@ -242,10 +242,8 @@ def clone(ui, source, dest=None, pull=Fa
         if islocal(dest):
             dir_cleanup = DirCleanup(dest)
 
-        abspath = origsource
         copy = False
         if src_repo.cancopy() and islocal(dest):
-            abspath = os.path.abspath(util.drop_scheme('file', origsource))
             copy = not pull and not rev
 
         if copy:
@@ -323,10 +321,10 @@ def clone(ui, source, dest=None, pull=Fa
         if dest_repo.local():
             fp = dest_repo.opener("hgrc", "w", text=True)
             fp.write("[paths]\n")
-            fp.write("default = %s\n" % abspath)
+            fp.write("default = %s\n" % origsource)
             fp.close()
 
-            dest_repo.ui.setconfig('paths', 'default', abspath)
+            dest_repo.ui.setconfig('paths', 'default', origsource)
 
             if update:
                 if update is not True:
</attachpara></page></attachment></attachments><normalized-references><normalized-message-id>1268254688.73.0.785894514771.issue2086@mercurial.selenic.com</normalized-message-id><normalized-in-reply-to>1268254688.73.0.785894514771.issue2086@mercurial.selenic.com</normalized-in-reply-to></normalized-references><body><para depth="0">
New submission from Glenn Hutchings &lt;<email>zondo42@googlemail.com</email>&gt;:

</para><para depth="0">There's a problem when cloning from a repo specified using the 'schemes'
extension.  If the scheme is a local file, the 'default' path in the clone's
.hg/hgrc is set incorrectly.  For example, suppose this is the setup in your
hgrc:

</para><para depth="0">[extensions]
schemes = 

</para><para depth="0">[schemes]
main = /path/to/repodirs

</para><para depth="0">Running the command 'hg clone main://myrepo' from directory '/home/glenn'
(assuming myrepo exists in repodirs) results in a cloned repo with the
default path set to '/home/glenn:/myrepo' instead of 'main://myrepo' as
expected.

</para><para depth="0">I've attached a patch which fixes this problem (but not entirely sure it
doesn't introduce others).

</para><para depth="0">----------
files: file-scheme-bug.patch
messages: 12008
nosy: zondo
priority: bug
status: unread
title: Problem setting default path when cloning from local-file scheme

</para><para depth="0">____________________________________________________
Mercurial issue tracker &lt;<email>bugs@mercurial.selenic.com</email>&gt;
&lt;<url>http://mercurial.selenic.com/bts/issue2086</url>&gt;
</para><para depth="0">____________________________________________________
</para><para depth="0">schemes: fix default path setting when cloning from local file schemes

</para><para depth="0">diff --git a/mercurial/hg.py b/mercurial/hg.py
--- a/mercurial/hg.py
+++ b/mercurial/hg.py
@@ -242,10 +242,8 @@ def clone(ui, source, dest=None, pull=Fa
         if islocal(dest):
             dir_cleanup = DirCleanup(dest)

</para><para depth="0">-        abspath = origsource
         copy = False
         if src_repo.cancopy() and islocal(dest):
-            abspath = os.path.abspath(util.drop_scheme('file', origsource))
             copy = not pull and not rev

</para><para depth="0">         if copy:
@@ -323,10 +321,10 @@ def clone(ui, source, dest=None, pull=Fa
         if dest_repo.local():
             fp = dest_repo.opener("hgrc", "w", text=True)
             fp.write("[paths]\n")
-            fp.write("default = %s\n" % abspath)
+            fp.write("default = %s\n" % origsource)
             fp.close()

</para><para depth="0">-            dest_repo.ui.setconfig('paths', 'default', abspath)
+            dest_repo.ui.setconfig('paths', 'default', origsource)

</para><para depth="0">             if update:
                 if update is not True:
</para><footer type="list-management" depth="0">_______________________________________________
Mercurial-devel mailing list
<email>Mercurial-devel@selenic.com</email>
<url>http://selenic.com/mailman/listinfo/mercurial-devel</url>
</footer></body></message>