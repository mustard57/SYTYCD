<message message-id="20060818222725.GN5342@plum.flirble.org" list="org.perl.perl5-porters" id="24cslcrwdqayw3sj" type="development" date="2006-08-18T23:27:25+01:00" year="2006-01-01" year-month="2006-08-01" year-month-day="2006-08-18" thread-id="24cslcrwdqayw3sj"><headers><envelope-from-line>From nntpsnarfer@fakefrom.com  Mon Jan  1 12:00:00 1990</envelope-from-line><from personal="Nicholas Clark" address="nick@ccl4.org">Nicholas Clark &lt;nick@ccl4.org&gt;</from><to personal="David Nicol" address="davidnicol@gmail.com">David Nicol &lt;davidnicol@gmail.com&gt;</to><cc personal="perlbug-followup@perl.org" address="perlbug-followup@perl.org">perlbug-followup@perl.org</cc><subject normal="[perl #40194] grep autovifies hash elements">Re: [perl #40194] grep autovifies hash elements</subject><newsgroups>perl.perl5.porters</newsgroups><path>nntp.perl.org</path><xref>nntp.perl.org perl.perl5.porters:115838</xref><return-path>nick@flirble.org</return-path><mailing-list>contact perl5-porters-help@perl.org; run by ezmlm</mailing-list><delivered-to>mailing list perl5-porters@perl.org</delivered-to><received>(qmail 31913 invoked from network); 18 Aug 2006 22:27:42 -0000</received><received>from x1a.develooper.com (HELO x1.develooper.com) (216.52.237.111)
  by lists.develooper.com with SMTP; 18 Aug 2006 22:27:42 -0000</received><received>(qmail 17716 invoked by uid 225); 18 Aug 2006 22:27:42 -0000</received><delivered-to>perl5-porters@perl.org</delivered-to><received>(qmail 17702 invoked by alias); 18 Aug 2006 22:27:42 -0000</received><x-spam-status>No, hits=-2.6 required=8.0
	tests=BAYES_00</x-spam-status><x-spam-check-by>la.mx.develooper.com</x-spam-check-by><received-spf>neutral (x1.develooper.com: 63.251.223.186 is neither permitted nor denied by domain of nick@flirble.org)</received-spf><received>from x6.develooper.com (HELO lists.develooper.com) (63.251.223.186)
    by la.mx.develooper.com (qpsmtpd/0.28) with SMTP; Fri, 18 Aug 2006 15:27:40 -0700</received><received>(qmail 31910 invoked by uid 514); 18 Aug 2006 22:27:35 -0000</received><delivered-to>perlmail-perlbug-followup@onion.perl.org</delivered-to><received>(qmail 31907 invoked from network); 18 Aug 2006 22:27:35 -0000</received><received>from x1a.develooper.com (HELO x1.develooper.com) (216.52.237.111)
  by lists.develooper.com with SMTP; 18 Aug 2006 22:27:35 -0000</received><received>(qmail 17674 invoked by uid 225); 18 Aug 2006 22:27:35 -0000</received><delivered-to>perlbug-followup@perl.org</delivered-to><received>(qmail 17670 invoked by alias); 18 Aug 2006 22:27:34 -0000</received><received-spf>pass (x1.develooper.com: domain of nick@flirble.org designates 195.40.6.20 as permitted sender)</received-spf><received>from plum.flirble.org (HELO plum.flirble.org) (195.40.6.20)
    by la.mx.develooper.com (qpsmtpd/0.28) with ESMTP; Fri, 18 Aug 2006 15:27:32 -0700</received><received>from nick by plum.flirble.org with local (Exim 4.43)
	id 1GECoH-000CiT-II; Fri, 18 Aug 2006 23:27:25 +0100</received><date>Fri, 18 Aug 2006 23:27:25 +0100</date><message-id>20060818222725.GN5342@plum.flirble.org</message-id><mail-followup-to>David Nicol &lt;davidnicol@gmail.com&gt;,
	perlbug-followup@perl.org</mail-followup-to><references>&lt;RT-Ticket-40194@perl.org&gt; &lt;5.8.8_24277_1155862547@schmorp.de&gt; &lt;rt-3.5.HEAD-31251-1155862879-959.40194-75-0@perl.org&gt; &lt;934f64a20608181307m6b85722ew6cc5d06bc4f4c160@mail.gmail.com&gt;</references><mime-version>1.0</mime-version><content-type>text/plain; charset=us-ascii</content-type><content-disposition>inline</content-disposition><in-reply-to>&lt;934f64a20608181307m6b85722ew6cc5d06bc4f4c160@mail.gmail.com&gt;</in-reply-to><user-agent>Mutt/1.3.25i</user-agent><x-organisation>Tetrachloromethane</x-organisation><sender>Nicholas Clark &lt;nick@flirble.org&gt;</sender><x-old-spam-check-by>la.mx.develooper.com</x-old-spam-check-by><x-old-spam-status>No, hits=-2.6 required=8.0
	tests=BAYES_00,SPF_HELO_PASS,SPF_PASS</x-old-spam-status></headers><normalized-references><normalized-message-id>20060818222725.GN5342@plum.flirble.org</normalized-message-id><normalized-in-reply-to>934f64a20608181307m6b85722ew6cc5d06bc4f4c160@mail.gmail.com</normalized-in-reply-to><normalized-reference>RT-Ticket-40194@perl.org</normalized-reference><normalized-reference>5.8.8_24277_1155862547@schmorp.de</normalized-reference><normalized-reference>rt-3.5.HEAD-31251-1155862879-959.40194-75-0@perl.org</normalized-reference><normalized-reference>934f64a20608181307m6b85722ew6cc5d06bc4f4c160@mail.gmail.com</normalized-reference></normalized-references><body type="text/plain; charset=us-ascii"><para depth="0">On Fri, Aug 18, 2006 at 03:07:08PM -0500, David Nicol wrote:
</para><quote depth="1"><quotepara depth="1">On 8/17/06, via RT Marc Lehmann &lt;<email>perlbug-followup@perl.org</email>&gt; wrote:
</quotepara><quote depth="2"><quotepara depth="2">grep "autovifies" hash elements:

</quotepara><quotepara depth="2">  perl -MData::Dumper -e 'grep 1, $hash{key}; warn Dumper \%hash'

</quotepara><quotepara depth="2">shows that $hash{key} is undef when it should not exist at all. The same
is true for map and for.
</quotepara></quote><quotepara depth="1">
It is well-documented that hash elements are autovivved whenever they
are so much as thought about.  the exists() function exists to examine
a hash entry that might not be there, and tread softly while doing it.
</quotepara></quote><para depth="0">
Wrong.

</para><para depth="0">$ perl -wle 'sub foo {print defined $_[0]; } foo($hash{key}); print keys %hash'

</para><para depth="0">$

</para><para depth="0">2 blank lines. The key is not autovivified if it's used as a subroutine
argument. This is achieved with lots of effort through PVLVs and magic:

</para><para depth="0">$ perl -MDevel::Peek -e 'sub foo {Dump $_[0]; } foo($hash{key});'
SV = PVLV(0x807f038) at 0x804d16c
  REFCNT = 1
  FLAGS = (GMG,SMG)
  IV = 0
  NV = 0
  PV = 0
  MAGIC = 0x80865d8
    MG_VIRTUAL = &amp;PL_vtbl_defelem
    MG_TYPE = PERL_MAGIC_defelem(y)
    MG_FLAGS = 0x02
      REFCOUNTED
    MG_OBJ = 0x804d2c8
    SV = PVIV(0x804f82c) at 0x804d2c8
      REFCNT = 1
      FLAGS = (POK,pPOK)
      IV = 0
      PV = 0x8050828 "key"\0
      CUR = 3
      LEN = 4
  TYPE = y
  TARGOFF = 0
  TARGLEN = 1
  TARG = 0x807cf4c
  SV = PVHV(0x8052720) at 0x807cf4c
    REFCNT = 2
    FLAGS = (SHAREKEYS)
    IV = 0
    NV = 0
    ARRAY = 0x0
    KEYS = 0
    FILL = 0
    MAX = 7
    RITER = -1
    EITER = 0x0

</para><para depth="0">I assume that the same approach could be used by grep for not-yet-existing
hash keys.

</para><footer type="signature" hash="16271042718256530959" depth="0">Nicholas Clark

</footer></body></message>